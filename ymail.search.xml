<?xml version="1.0" encoding="UTF-8"?>
<i:table xmlns:i="http://query.yahooapis.com/v1/schema/internalTable.xsd" xmlns="http://query.yahooapis.com/v1/schema/table.xsd" securityLevel="user">
  <meta>
    <author>Yahoo! Inc.</author>
    <sampleQuery>select * from {table} where numMid='3'</sampleQuery>
	<sampleQuery>select * from {table} where query='Yahoo'</sampleQuery>
	<description> This table helps you to list messages or search content in your mailbox </description>
  </meta>
  <i:bindings>
   <i:select itemPath="json" produces="JSON" auth="yahooOauth" >
      <inputs>
	  	    <key id="query" type='xs:string' paramType='variable' />
		    <key id="fr" type='xs:string' paramType='variable' />
	   	  <key id="to" type='xs:string' paramType='variable' />
	 	    <key id="subject" type='xs:string' paramType='variable'/>
		    <key id="cc" type='xs:string' paramType='variable' />
		    <key id="flags" type='xs:string' paramType='variable' />
		    <key id="attachment" type='xs:string' paramType='variable' />
		    <key id="attachmentcount" type='xs:string' paramType='variable' />
		    <key id="attachmenttype" type='xs:string' paramType='variable' />
		    <key id="attachmentname" type='xs:string' paramType='variable' />
		    <key id="fid" type='xs:string' paramType='variable' />
		    <key id="count" type='xs:string' paramType='variable' />
		    <key id="start" type='xs:string' paramType='variable' />
		    <key id="appid" type='xs:string' paramType='variable' />
	  </inputs>
	  <execute><![CDATA[
		
		y.include("http://github.com/gkanugov/mailsearchTables/raw/master/messages.js");
		y.include("http://github.com/gkanugov/mailsearchTables/raw/master/json2.js");
	
        //Intialization
        var content = '';
        var params = '[{}]';

	      var searchParams; 
        if (inputs['query'] != null) {
          searchParams = { "keyword" : inputs['query']};
        }
        else {
          searchParams = { };
        }

        if (inputs['fr'] != null) {
          searchParams.from = inputs['fr'];
        }

        if (inputs['to'] != null) {
          searchParams.to = inputs['to'];
        }

        if (inputs['subject'] != null) {
          searchParams.subject = inputs['subject'];
        }

        var jsonStr = JSON.stringify(searchParams);
        y.log(jsonStr);

	var content = 'query=' + escape(jsonStr) + '&count=10&start=0&appid=yqltest'; 
	y.log(content);


	//var url = 'http://mail.yahooapis.com/mailsearch/v1/search?query=%7B"keyword":"yahoo"%7D&count=10&start=0&appid=mswstest';
	var url = 'http://mail.yahooapis.com/mailsearch/v1';
  var pathStr = 'search?'+content;
	 var appauth = request.headers['Yahoo-App-Auth'];	
  var at = 'U=LSB0PXAgYz1kajB5Sm1rOU9FSlBaVmxxTlRob1ZrWnZKbVE5V1Zkck9VeFhNWHBrTTA0d1RqSk5iV05IYnpsTlExbzFVRlJGTFNaelBXTnZibk4xYldWeWMyVmpjbVYwSm5nOVl6TS0gWT12PTEmbj05cTdjYzBnOGdoZ2ZuJmw9Nl9qNGlqOGQ2XzAyMi9vJnA9bTJiMDAwMDAxMjAwMDAwMCZyPW1sJmxnPWVuLUlOJmludGw9aW4gVD16PXNTcE5NQnNTcE5NQjRvRlpDMVkyZXhNTkRVMEJqTTBUalkzTjA0eE1URk9OakkwTWomYT1RQUUmc2s9REFBQUVGREQ3V1I4Q3gma3M9RUFBMDZNd3pBU0FhNlhPZXByZ3lzUVl1QS0tfkUmZD1jMndCVFhwSmVrRlVVWHBQVkVWM1RVUnJNazVxV1RWTlZGVjZUbFJOZUFGaEFWRkJSUUZuQVZVMVNFZERTMUZJVVZGVldrNWFTVVZDVlZwQlZVZE1SMGxCQVhScGNBRkVlSEpZVmtFQmVub0JjMU53VGsxQ1FUZEY-'
	var req = y.rest(url).path(pathStr).header('Authorization', at);
	 if (appauth) req.header('Yahoo-App-Auth', appauth);

	y.log(request.headers);
	response.object = req.get().response;	
//y.log(returned_response);
//  var temp = JSON.stringify(returned_response);
// y.log(temp);
 	//response.object = temp;

      ]]></execute>
   </i:select>
  </i:bindings>
</i:table>
